# ret_simulations
All code for current RET simulations on T2B

This is a full simulation framework to take you from input parameters to a full corsika shower. Additional steps can be used to calculate the deposition from the shower in scintillators on the ground plane and the fluence of the radio signal from the shower in radio antennas with a bandwidth of your choice. More steps are always being added so if a particular step you want to use isn't documented here contact Rose. 

All code that will need to be run by the user is written in python3. Ensure that the python3 environment is evaluated on the login node before running the code. Without an alternative source, running the command 'python ...' will run the code in a python2 environment and therefore, some fucntionality may not be fully usable.

To obtain the correct python3 environment I use the command `` eval `/cvmfs/icecube.opensciencegrid.org/py3-v4.0.1/setup.sh` ``

## Directory structure

` ~/ret_simulations ` - main directory for the simulation code

` ~/ret_simulations/corsika ` - directory containing all code necessary to write corsika input files, also contains completeness check for corsika simulations run

` ~/ret_simulations/gdastool ` - drectory containing all code necessary to write gdastool input files

` ~/ret_simulations/radio ` - directory containing all code necessary to write surface radio simulation input files, (including radio triggering code)

` ~/ret_simulations/surface ` - directory containing all code necessary to write surface particle simulation input files, including particle triggering code, also contains completeness check for surface particle simulations run

` ~/ret_simulaitons/HTCondor ` - directory containing all code necessary to generate and run job submission on the HTCondor system of T2B cluster

` ~/ret_simulations/HTCondor/corsika ` - directory containing code and .sh and .submit files to run a corsika job on the T2B cluster

` ~/ret_simulations/HTCondor/corsika/offset ` - direcotry containing offset files for corsika simulations detailing the number of corsika simulations that have been generated in input files

` ~/ret_simulations/HTCondor/gdastool ` - directory containing code and .sh and .submit files to run a gdastool job on the T2B cluster

` ~/ret_simulations/HTCondor/radio ` - directory containing code and .sh and .submit files to run a surface radio job on the T2B cluster

` ~/ret_simulations/HTCondor/surface ` - directory containing code and .sh and .submit files to run a surface particle job on the T2B cluster

` ~/ret_simulations/HTCondor/test ` - directory containing test .sh and .sumbit files (obsolete)

` ~/ret_simulations/HTCondor/*/write_dag ` - directory containing code to write dag files for jobs on the T2B cluster 

` ~/ret_simulations/HTCondor/*/dagfiles ` - output directory for all dag files to be run on the T2B cluster, not backed up on git hub due to file number and size, these files are generated by code stored in the ../write_dag directory

## How to run the full simulation chain 

Here we outline a brief work flow of how to create the different input files necessary to run each stage of the simulation.

In order to run the full simulation chain, in principle you should only need to operate within the directory ` ~/ret_simulations/HTCondor `. Through the code in this directory, the submissions for the HTCondor system are created. These in turn create all the necessary steering files for each stage of the simulation.

Before running any of these steps, evaluate the correct python3 environment using the command above.

### CORSIKA

The CORSIKA simulation is the first that needs to be run to start the simulation chain. To do this, navigate to the directory ` ~/ret_simulations/HTCondor/corsika/write_dag `

Run command `python write_corsika_dag.py -h `. This will bring up the help text from the programme. 

```
Usage: write_corsika_dag.py [options]

Options:
  -h, --help            show this help message and exit
  -n NUMBER, --number=NUMBER
                        number of 10^15.0 eV showers to generate
  -g GAMMA, --gamma=GAMMA
                        index of cosmic ray spectrum
  -d DISTRIBUTION, --distribution=DISTRIBUTION
                        theta angle distribution, flat in theta=theta, flat in
                        cos(theta)=costheta
  -b THETABIN, --thetabin=THETABIN
                        bin for theta angle, sets the minimum and maximum
                        theta angle. 0: 0 <= t < 30 degrees,1: 30 <= t < 45
                        degrees, 2: 45 <= t < 55 degrees, 3: 55 <= t < 65
                        degrees
  -p PRIMARY, --primary=PRIMARY
                        primary particle type, proton or iron
  -s SEASON, --season=SEASON
                        season for atmosphere profile, s=summer, w=winter,
                        g=general
  -t TIME, --time=TIME  time for atmospheric profile, d=day, n=night,
                        g=general
  -l LOCATION, --location=LOCATION
                        location of detector, td=Taylor Dome

```
Choose the values of the parameters that you want to run the simulations with and run a command with the format:

` python write_corsika_dag.py -n 1000 -g -1 -d costheta -b 0 -p proton -s s -t g -l td `

This command will create a dagfile with all the submission parameters for the simulations to be run using the parameters specified. This dagfile can be found in the directory ` ~/ret_simulations/HTCondor/corsika/dagfiles ` and then in nested directory, the first labelled with the date and the second with the time ie. ` ~/ret_simulations/HTCondor/corsika/dagfiles/yyyymmdd/hhmmss `.

Navigate to this directory and then run the command ` condor_submit_dag run_corsika_shower_yyyymmdd_hhmmss.dag `. This will begin the submission process for the CORSIKA showers. Once the CORSIKA shower has completed, it also runs a GEANT4 simulation necessary for progressing to the surface simulations. The radio simulations do not require these GEANT4 simulations, instead the requirements are met by running CoREAS in conjunction with CORSIKA. 

To check up on the progress of your simulations use ` condor_q `.

Once all the simulations have been run, you can check how complete the resulting library is by using the programme ` ~/ret_simulations/corsika/completeness_check.py `. Running `python completeness_check.py -h ` prints the help.

```
Usage: completeness_check.py [options]

Options:
  -h, --help            show this help message and exit
  -d DISTRIBUTION, --distribution=DISTRIBUTION
                        theta angle distribution, flat in theta=theta, flat in
                        cos(theta)=costheta
  -p PRIMARY, --primary=PRIMARY
                        primary particle type, proton or iron
  -s SEASON, --season=SEASON
                        season for atmosphere profile, s=summer, w=winter,
                        g=general
  -t TIME, --time=TIME  time for atmospheric profile, d=day, n=night,
                        g=general
  -l LOCATION, --location=LOCATION
                        location of detector, td=Taylor Dome
```

Using the same parameters as above as an example, a completeness check can be run using ` python completeness_check.py -d costheta -p proton -s s -t g -l td `. This will print all the simulations that need to be run again to make the library complete.

### Surface

Running the surface simulations requires that all the CORSIKA simulations have finished successfully. Once they are complete, the surface simulation dagfiles can be created. Navigate to the directory ` ~/ret_simulations/HTCondor/surface/write_dag `.

Run command `python write_surface_dag.py -h `. This will bring up the help text from the programme. 

```
Usage: write_surface_dag.py [options]

Options:
  -h, --help            show this help message and exit
  -r RUNNUMBER, --runnumber=RUNNUMBER
                        number of showers to use at each energy
  -d DISTRIBUTION, --distribution=DISTRIBUTION
                        theta angle distribution, flat in theta=theta, flat in
                        cos(theta)=costheta
  -z ZENITHBIN, --zenithbin=ZENITHBIN
                        zenith bin number of shower, 0-3
  -p PRIMARY, --primary=PRIMARY
                        primary particle type, proton or iron
  -s SEASON, --season=SEASON
                        season for atmosphere profile, s=summer, w=winter,
                        g=general
  -t TIME, --time=TIME  time for atmospheric profile, d=day, n=night,
                        g=general
  -l LOCATION, --location=LOCATION
                        location of detector, td=Taylor Dome
  --arraynumber=ARRAYNUMBER
                        number of array layout
  --radius=RADIUS       maximum radius of shower core
  --trynumber=TRYNUMBER
                        number of core positions to chose
```

Choose the values of the parameters that you want to run the simulations with and run a command with the format:

` python write_surface_dag.py -r 500 -d costheta -z 0 -p proton -s s -t g -l td --arraynumber 1 --radius 300 --trynumber 100 `

This command will create a dagfile with all the submission parameters for the simulations to be run using the parameters specified. This dagfile can be found in the directory ` ~/ret_simulations/HTCondor/surface/dagfiles ` and then in nested directory, the first labelled with the date and the second with the time ie. ` ~/ret_simulations/HTCondor/surface/dagfiles/yyyymmdd/hhmmss `. 

Navigate to this directory and then run the command ` condor_submit_dag run_surface_sim_yyyymmdd_hhmmss.dag `. This will begin the submission process for the surface simulations. 

To check up on the progress of your simulations use ` condor_q `.

### Radio
